-- Fishing Tab for FishClarity
-- Smart Detector feature for stuck detection and auto-reset

return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")
	local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay
	local initialFishCount = 0 -- Fish count when detector started
	local fishCaughtSinceStart = 0 -- Fish caught since detector started
	
	-- Connections for Smart Detector loops
	local timerConnection = nil
	local statusConnection = nil

	-- Auto Fish variables
	local legitAutoFishEnabled = false
	local autoEquipRodEnabled = false
	local autoClickMinigame = false
	local castDelay = 1
	local reelDelay = 1
	local autoFishConnection = nil
	local equipRodConnection = nil

	-- Event Fishing variables
	local eventTeleportEnabled = false
	local selectedEvents = {}
	local eventPriority = "Closest"
	local eventTeleportConnection = nil

	-- Favorite variables
	local autoFavoriteEnabled = false
	local autoUnfavoriteEnabled = false
	local selectedFishNames = {}
	local selectedFishRarities = {}
	local selectedFishVariants = {}
	local favoriteConnection = nil
	local unfavoriteConnection = nil

	-- Sell variables
	local autoSellEnabled = false
	local sellThreshold = 30
	local sellConnection = nil

	-- ============================================
	-- LEGIT AUTO FISH VARIABLES
	-- ============================================
	local legitAutoFishEnabled = false
	local legitFishingLoop = nil
	local legitMinigameActive = false
	local legitMinigameConnection = nil
	local autoClickMinigameEnabled = false
	local legitDelay = 1.1
	local shakeDelay = 0.1
	local manipulationDelay = 0.12

	-- ============================================
	-- AUTO EQUIP ROD VARIABLES
	-- ============================================
	local autoEquipRodEnabled = false
	local autoEquipConnection = nil

	-- ============================================
	-- EVENT FISHING VARIABLES
	-- ============================================
	local eventTeleportEnabled = false
	local selectedEvents = {}
	local prioritizedEvent = "Ghost Shark Hunt"
	local eventTeleportConnection = nil

	-- ============================================
	-- FAVORITE SYSTEM VARIABLES
	-- ============================================
	local autoFavoriteEnabled = false
	local autoUnfavoriteEnabled = false
	local selectedFishNames = {}
	local selectedRarity = {}
	local selectedVariant = {}
	local favoriteConnection = nil

	-- ============================================
	-- AUTO SELL VARIABLES
	-- ============================================
	local autoSellEnabled = false
	local sellThreshold = 0
	local sellConnection = nil

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get total fish count from inventory
	local function getTotalFishCount()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)
			if success and items then
				local count = 0
				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" then
						count = count + (item.Count or 1)
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d/%d", detectorTimer, waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Fish Caught: %d", fishCaughtSinceStart))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- ============================================
	-- LEGIT AUTO FISH FUNCTIONS
	-- ============================================

	-- Start legit auto fish
	local function StartLegitAutoFish()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		if not isRodEquipped() then
			Notifier.new({
				Title = "Error",
				Content = "No fishing rod equipped!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		legitAutoFishEnabled = true

		legitFishingLoop = task.spawn(function()
			while legitAutoFishEnabled do
				pcall(function()
					if not isRodEquipped() then
						task.wait(1)
						return
					end

					local currentGUID = FishingController:GetCurrentGUID()
					if currentGUID == nil then
						-- Not in minigame, cast the rod
						FishingController:RequestCast()
						task.wait(legitDelay)
					else
						-- In minigame
						if not legitMinigameActive then
							legitMinigameActive = true
							task.wait(shakeDelay)
						end

						if legitMinigameActive then
							-- Auto-click minigame if enabled
							if autoClickMinigameEnabled then
								local success, progress = pcall(function()
									return FishingController:GetProgress()
								end)

								if success and progress then
									if progress >= 1 then
										-- Complete the minigame
										pcall(function() finishRemote:FireServer() end)
										legitMinigameActive = false
										task.wait(manipulationDelay)
									else
										-- Click to progress
										VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
										task.wait(0.01)
										VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
										task.wait(manipulationDelay)
									end
								end
							end
						end
					end
				end)
				task.wait(0.1)
			end
		end)
	end

	-- Stop legit auto fish
	local function StopLegitAutoFish()
		legitAutoFishEnabled = false
		legitMinigameActive = false
		if legitFishingLoop then
			task.cancel(legitFishingLoop)
			legitFishingLoop = nil
		end
	end

	-- ============================================
	-- AUTO EQUIP ROD FUNCTIONS
	-- ============================================

	-- Start auto equip rod
	local function startAutoEquipRod()
		if autoEquipConnection then
			autoEquipConnection:Disconnect()
		end

		autoEquipConnection = replion:OnChange({"EquippedType"}, function(newType)
			if autoEquipRodEnabled and newType ~= "Fishing Rods" then
				pcall(function() REEquipToolFromHotbar:FireServer(1) end)
			end
		end)
	end

	-- Stop auto equip rod
	local function stopAutoEquipRod()
		if autoEquipConnection then
			autoEquipConnection:Disconnect()
			autoEquipConnection = nil
		end
	end

	-- ============================================
	-- EVENT FISHING FUNCTIONS
	-- ============================================

	-- Get available events
	local function getAvailableEvents()
		local events = {}
		local workspaceEvents = workspace:FindFirstChild("Events")
		if workspaceEvents then
			for _, eventPart in ipairs(workspaceEvents:GetChildren()) do
				if eventPart:IsA("BasePart") then
					table.insert(events, eventPart.Name)
				end
			end
		end
		return events
	end

	-- Get all available fish names
	local function getAllFishNames()
		local fishNames = {}
		if ItemUtility and ItemUtility.Fish then
			for name, _ in pairs(ItemUtility.Fish) do
				table.insert(fishNames, name)
			end
		end
		table.sort(fishNames)
		return fishNames
	end

	-- Get all available fish variants
	local function getAllFishVariants()
		local variants = {}
		if ItemUtility and ItemUtility.Fish then
			for _, fishData in pairs(ItemUtility.Fish) do
				if fishData.Variants then
					for variant, _ in pairs(fishData.Variants) do
						if not table.find(variants, variant) then
							table.insert(variants, variant)
						end
					end
				end
			end
		end
		table.sort(variants)
		return variants
	end

	-- Teleport to event
	local function teleportToEvent(eventPart, eventName)
		if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end

		local hrp = player.Character.HumanoidRootPart
		local eventPosition = eventPart.Position

		-- Create body position for smooth teleport
		local bodyPosition = Instance.new("BodyPosition")
		bodyPosition.Position = eventPosition + Vector3.new(0, 5, 0)
		bodyPosition.MaxForce = Vector3.new(10000, 10000, 10000)
		bodyPosition.D = 2000
		bodyPosition.P = 25000
		bodyPosition.Parent = hrp

		task.wait(2)
		bodyPosition:Destroy()
	end

	-- Start event teleport
	local function startEventTeleport()
		if eventTeleportConnection then
			eventTeleportConnection:Disconnect()
		end

		eventTeleportConnection = RunService.Heartbeat:Connect(function()
			if not eventTeleportEnabled then return end

			local workspaceEvents = workspace:FindFirstChild("Events")
			if not workspaceEvents then return end

			-- Check for prioritized event first
			if prioritizedEvent then
				local prioritizedPart = workspaceEvents:FindFirstChild(prioritizedEvent)
				if prioritizedPart and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local distance = (prioritizedPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
					if distance > 50 then -- Only teleport if far away
						teleportToEvent(prioritizedPart, prioritizedEvent)
						Notifier.new({
							Title = "Event Teleport",
							Content = "Teleported to prioritized " .. prioritizedEvent,
							Duration = 3,
							Icon = "rbxassetid://95448792622941"
						})
						return
					end
				end
			end

			-- Check for selected events
			for _, eventName in ipairs(selectedEvents) do
				local eventPart = workspaceEvents:FindFirstChild(eventName)
				if eventPart and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local distance = (eventPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
					if distance > 50 then
						teleportToEvent(eventPart, eventName)
						Notifier.new({
							Title = "Event Teleport",
							Content = "Teleported to " .. eventName,
							Duration = 3,
							Icon = "rbxassetid://95448792622941"
						})
						return
					end
				end
			end
		end)
	end

	-- Stop event teleport
	local function stopEventTeleport()
		if eventTeleportConnection then
			eventTeleportConnection:Disconnect()
			eventTeleportConnection = nil
		end
	end

	-- ============================================
	-- FAVORITE SYSTEM FUNCTIONS
	-- ============================================

	-- Check if fish matches criteria
	local function fishMatchesCriteria(fishName, fishData)
		-- Check name
		if #selectedFishNames > 0 then
			local nameMatches = false
			for _, selectedName in ipairs(selectedFishNames) do
				if fishName:find(selectedName) then
					nameMatches = true
					break
				end
			end
			if not nameMatches then return false end
		end

		-- Check rarity
		if #selectedRarity > 0 then
			local rarity = fishData and fishData.Rarity or "Common"
			local rarityMatches = false
			for _, selectedRarityItem in ipairs(selectedRarity) do
				if rarity == selectedRarityItem then
					rarityMatches = true
					break
				end
			end
			if not rarityMatches then return false end
		end

		-- Check variant
		if #selectedVariant > 0 then
			local variant = fishData and fishData.Variant or nil
			local variantMatches = false
			for _, selectedVariantItem in ipairs(selectedVariant) do
				if variant == selectedVariantItem then
					variantMatches = true
					break
				end
			end
			if not variantMatches then return false end
		end

		return true
	end

	-- Start auto favorite
	local function startAutoFavorite()
		if favoriteConnection then
			favoriteConnection:Disconnect()
		end

		favoriteConnection = finishRemote.OnClientEvent:Connect(function()
			if not autoFavoriteEnabled then return end

			task.wait(0.5) -- Wait for inventory to update

			if replion then
				local success, items = pcall(function()
					return replion:GetExpect({"Inventory", "Items"})
				end)

				if success and items then
					for _, item in ipairs(items) do
						local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
						if itemData and itemData.Data and itemData.Data.Type == "Fish" then
							local fishName = itemData.Data.Name or item.Id

							if fishMatchesCriteria(fishName, itemData.Data) and not item.Favorite then
								-- Favorite the fish
								local favoriteRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
									:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FavoriteItem")

								pcall(function() favoriteRemote:FireServer(item.Id, true) end)
							end
						end
					end
				end
			end
		end)
	end

	-- Stop auto favorite
	local function stopAutoFavorite()
		if favoriteConnection then
			favoriteConnection:Disconnect()
			favoriteConnection = nil
		end
	end

	-- Start auto unfavorite
	local function startAutoUnfavorite()
		if favoriteConnection then
			favoriteConnection:Disconnect()
		end

		favoriteConnection = finishRemote.OnClientEvent:Connect(function()
			if not autoUnfavoriteEnabled then return end

			task.wait(0.5) -- Wait for inventory to update

			if replion then
				local success, items = pcall(function()
					return replion:GetExpect({"Inventory", "Items"})
				end)

				if success and items then
					for _, item in ipairs(items) do
						local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
						if itemData and itemData.Data and itemData.Data.Type == "Fish" then
							local fishName = itemData.Data.Name or item.Id

							if fishMatchesCriteria(fishName, itemData.Data) and item.Favorite then
								-- Unfavorite the fish
								local favoriteRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
									:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FavoriteItem")

								pcall(function() favoriteRemote:FireServer(item.Id, false) end)
							end
						end
					end
				end
			end
		end)
	end

	-- Stop auto unfavorite
	local function stopAutoUnfavorite()
		if favoriteConnection then
			favoriteConnection:Disconnect()
			favoriteConnection = nil
		end
	end

	-- Unfavorite all fish
	local function unfavoriteAllFish()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)

			if success and items then
				local favoriteRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
					:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FavoriteItem")

				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" and item.Favorite then
						pcall(function() favoriteRemote:FireServer(item.Id, false) end)
					end
				end

				Notifier.new({
					Title = "Unfavorite All",
					Content = "Unfavorited all fish",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end
	end

	-- ============================================
	-- AUTO SELL FUNCTIONS
	-- ============================================

	-- Sell all items
	local function sellAllItems()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)

			if success and items then
				local sellRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
					:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/SellItem")

				for _, item in ipairs(items) do
					if item.Count and item.Count > 0 then
						pcall(function() sellRemote:FireServer(item.Id, item.Count) end)
					end
				end

				Notifier.new({
					Title = "Sell All",
					Content = "Sold all items",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end
	end

	-- Start auto sell
	local function startAutoSell()
		if sellConnection then
			sellConnection:Disconnect()
		end

		local lastSellTime = tick()
		sellConnection = RunService.Heartbeat:Connect(function()
			if not autoSellEnabled or sellThreshold <= 0 then return end

			local currentTime = tick()
			if currentTime - lastSellTime >= sellThreshold then
				lastSellTime = currentTime
				sellAllItems()
			end
		end)
	end

	-- Stop auto sell
	local function stopAutoSell()
		if sellConnection then
			sellConnection:Disconnect()
			sellConnection = nil
		end
	end

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		lastResetTime = tick()
		currentStatus = "Resetting..."
		updateDisplays()

		-- Save current position RIGHT BEFORE resetting
		local savedPosition = nil
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			savedPosition = player.Character.HumanoidRootPart.Position
		end

		-- Reset character
		pcall(function()
			player.Character:BreakJoints()
		end)

		-- Wait for player to respawn (detect when character is added back)
		local respawned = false
		local connection
		connection = player.CharacterAdded:Connect(function(newChar)
			respawned = true
			connection:Disconnect()
		end)

		-- Wait for respawn (max 10 seconds timeout)
		local waitStart = tick()
		while not respawned and (tick() - waitStart) < 10 do
			task.wait(0.1)
		end

		if connection then
			connection:Disconnect()
		end

		-- Wait 2 seconds after respawn finishes
		task.wait(2)

		-- Teleport back to saved position
		if savedPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(savedPosition)
				task.wait(0.5)
			end
		end

		-- Re-equip rod
		pcall(function() REEquipToolFromHotbar:FireServer(1) end)
		task.wait(2)

		currentStatus = "Ready"
		updateDisplays()
	end

	-- Stop Smart Detector and reset all variables
	local function stopSmartDetector()
		smartDetectorEnabled = false
		
		-- Disconnect existing connections
		if timerConnection then
			timerConnection:Disconnect()
			timerConnection = nil
		end
		if statusConnection then
			statusConnection:Disconnect()
			statusConnection = nil
		end
		
		detectorTimer = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = "Inactive"
		initialFishCount = 0
		fishCaughtSinceStart = 0
		
		-- Force update displays to reset values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: Inactive")
		end

		Notifier.new({
			Title = "Smart Detector",
			Content = "Stopped monitoring",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		-- FULLY RESET all variables when starting
		smartDetectorEnabled = true
		detectorTimer = 0
		initialFishCount = getTotalFishCount()
		fishCaughtSinceStart = 0
		lastResetTime = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = isRodEquipped() and "Active" or "No Rod"

		-- Save original position
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
			lastCastPosition = originalPosition
		end

		-- Force update all displays with fresh values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end

		Notifier.new({
			Title = "Smart Detector",
			Content = "Started monitoring fishing activity",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})

		-- Timer countdown connection (runs every second)
		local lastTimerUpdate = tick()
		timerConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastTimerUpdate >= 1 then
				lastTimerUpdate = currentTime
				
				-- Only increment timer if rod is equipped
				if isRodEquipped() then
					detectorTimer = detectorTimer + 1
					updateDisplays()

					if detectorTimer >= waitTime then
						if (tick() - lastResetTime) >= RESET_COOLDOWN then
							Notifier.new({
								Title = "Smart Detector",
								Content = "Timer expired - resetting character",
								Duration = 3,
								Icon = "rbxassetid://95448792622941"
							})
							resetCharacter()
							detectorTimer = 0
						else
							detectorTimer = 0
						end
					end
				else
					-- Reset timer if no rod equipped
					detectorTimer = 0
					updateDisplays()
				end
			end
		end)

		-- Status monitoring connection (runs every 0.1 seconds)
		local lastMinigameTime = nil
		local lastStatusUpdate = tick()
		statusConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastStatusUpdate < 0.1 then return end
			lastStatusUpdate = currentTime
			
			pcall(function()
				if not isRodEquipped() then
					currentStatus = "No Rod"
					updateDisplays()
					return
				end

				local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

				if currentMinigameActive then
					currentStatus = "Minigame"
					updateDisplays()

					if not lastMinigameTime then
						lastMinigameTime = tick()
					end

					local elapsed = tick() - lastMinigameTime

					if elapsed >= 1.1 then
						-- Complete the minigame
						pcall(function() finishRemote:FireServer() end)
						lastMinigameTime = nil

						-- Check if fish was caught
						task.wait(0.5)
						local newFishCount = getTotalFishCount()
						if newFishCount > initialFishCount then
							-- Fish was caught, reset timer
							detectorTimer = 0
							fishCaughtSinceStart = newFishCount - initialFishCount
							currentStatus = "Fish Caught"
							updateDisplays()

							Notifier.new({
								Title = "Smart Detector",
								Content = "Fish completed - timer reset",
								Duration = 2,
								Icon = "rbxassetid://95448792622941"
							})

							task.wait(1)
							currentStatus = "Active"
							updateDisplays()
						end
					end
				else
					if lastMinigameTime then
						lastMinigameTime = nil
					end

					-- Simple status detection: if rod equipped and not in minigame, check if casting
					if FishingController._getPower then
						local currentPower = FishingController:_getPower()

						-- If power is above 0, player is actively casting
						if currentPower > 0 then
							currentStatus = "Casting"
						else
							-- Rod equipped, not in minigame, power is 0 = Idle
							currentStatus = "Idle"
						end
					else
						-- Fallback: if we can't check power, assume Idle when rod is equipped
						currentStatus = "Idle"
					end

					updateDisplays()
				end
			end)
		end)
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: 0/" .. waitTime
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Fish Caught: " .. fishCaughtSinceStart
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			-- Don't update timer here, just change the selected time
			updateDisplays()

			Notifier.new({
				Title = "Wait Time",
				Content = "Set to " .. value .. " seconds",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});

	-- ============================================
	-- AUTO FISH SECTION
	-- ============================================

	local AutoFishSection = FishingTab:DrawSection({
		Name = "Auto Fish",
		Icon = "rbxassetid://95448792622941"
	});

	-- Legit Auto Fish toggle
	AutoFishSection:AddToggle({
		Name = "Legit Auto Fish",
		Default = false,
		Callback = function(enabled)
			if enabled then
				StartLegitAutoFish()
			else
				StopLegitAutoFish()
			end
		end,
	});

	-- Auto Equip Rod toggle
	AutoFishSection:AddToggle({
		Name = "Auto Equip Rod",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startAutoEquipRod()
			else
				stopAutoEquipRod()
			end
		end,
	});

	-- Auto Click Minigame toggle
	AutoFishSection:AddToggle({
		Name = "Auto Click Minigame",
		Default = false,
		Callback = function(enabled)
			autoClickMinigame = enabled
			if enabled then
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Enabled",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			else
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Disabled",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end,
	});

	-- Cast Delay textbox
	AutoFishSection:AddTextbox({
		Name = "Cast Delay (seconds)",
		Default = "1",
		TextDisappear = true,
		Callback = function(value)
			local num = tonumber(value)
			if num and num > 0 then
				castDelay = num
				Notifier.new({
					Title = "Cast Delay",
					Content = "Set to " .. num .. " seconds",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			else
				Notifier.new({
					Title = "Error",
					Content = "Invalid cast delay value",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end,
	});

	-- Reel Delay textbox
	AutoFishSection:AddTextbox({
		Name = "Reel Delay (seconds)",
		Default = "1",
		TextDisappear = true,
		Callback = function(value)
			local num = tonumber(value)
			if num and num > 0 then
				reelDelay = num
				Notifier.new({
					Title = "Reel Delay",
					Content = "Set to " .. num .. " seconds",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			else
				Notifier.new({
					Title = "Error",
					Content = "Invalid reel delay value",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end,
	});

	-- ============================================
	-- EVENT FISHING SECTION
	-- ============================================

	local EventFishingSection = FishingTab:DrawSection({
		Name = "Event Fishing",
		Icon = "rbxassetid://95448792622941"
	});

	-- Event selection dropdown
	EventFishingSection:AddDropdown({
		Name = "Select Events",
		Multi = true,
		Options = getAvailableEvents(),
		Default = {},
		Callback = function(selected)
			selectedEvents = selected
			Notifier.new({
				Title = "Events Selected",
				Content = "Selected " .. #selected .. " events",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});

	-- Event priority dropdown
	EventFishingSection:AddDropdown({
		Name = "Event Priority",
		Options = {"Closest", "Random", "Furthest"},
		Default = "Closest",
		Callback = function(selected)
			eventPriority = selected
			Notifier.new({
				Title = "Event Priority",
				Content = "Set to " .. selected,
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});

	-- Auto Teleport to Events toggle
	EventFishingSection:AddToggle({
		Name = "Auto Teleport to Events",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startEventTeleport()
			else
				stopEventTeleport()
			end
		end,
	});

	-- ============================================
	-- FAVORITE SECTION
	-- ============================================

	local FavoriteSection = FishingTab:DrawSection({
		Name = "Favorite",
		Icon = "rbxassetid://95448792622941"
	});

	-- Fish names dropdown
	FavoriteSection:AddDropdown({
		Name = "Fish Names",
		Multi = true,
		Options = getAllFishNames(),
		Default = {},
		Callback = function(selected)
			selectedFishNames = selected
		end,
	});

	-- Fish rarity dropdown
	FavoriteSection:AddDropdown({
		Name = "Fish Rarity",
		Multi = true,
		Options = {"Common", "Uncommon", "Rare", "Epic", "Legendary", "Mythic"},
		Default = {},
		Callback = function(selected)
			selectedFishRarities = selected
		end,
	});

	-- Fish variant dropdown
	FavoriteSection:AddDropdown({
		Name = "Fish Variant",
		Multi = true,
		Options = getAllFishVariants(),
		Default = {},
		Callback = function(selected)
			selectedFishVariants = selected
		end,
	});

	-- Auto Favorite toggle
	FavoriteSection:AddToggle({
		Name = "Auto Favorite",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startAutoFavorite()
			else
				stopAutoFavorite()
			end
		end,
	});

	-- Auto Unfavorite toggle
	FavoriteSection:AddToggle({
		Name = "Auto Unfavorite",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startAutoUnfavorite()
			else
				stopAutoUnfavorite()
			end
		end,
	});

	-- Unfavorite All button
	FavoriteSection:AddButton({
		Name = "Unfavorite All",
		Callback = function()
			unfavoriteAllFish()
		end,
	});

	-- ============================================
	-- SELL SECTION
	-- ============================================

	local SellSection = FishingTab:DrawSection({
		Name = "Sell",
		Icon = "rbxassetid://95448792622941"
	});

	-- Auto Sell toggle
	SellSection:AddToggle({
		Name = "Auto Sell",
		Default = false,
		Callback = function(enabled)
			autoSellEnabled = enabled
			if enabled then
				startAutoSell()
			else
				stopAutoSell()
			end
		end,
	});

	-- Sell Threshold textbox
	SellSection:AddTextbox({
		Name = "Sell Threshold (seconds)",
		Default = "30",
		TextDisappear = true,
		Callback = function(value)
			local num = tonumber(value)
			if num and num > 0 then
				sellThreshold = num
				Notifier.new({
					Title = "Sell Threshold",
					Content = "Set to " .. num .. " seconds",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			else
				Notifier.new({
					Title = "Error",
					Content = "Invalid sell threshold value",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				})
			end
		end,
	});

	-- Sell All button
	SellSection:AddButton({
		Name = "Sell All",
		Callback = function()
			sellAllItems()
		end,
	});
end
