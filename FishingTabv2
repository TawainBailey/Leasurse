-- Fishing Tab for FishClarity
-- Smart Detector feature for stuck detection and auto-reset

return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get player bag/fish count (simplified)
	local function getBagCount()
		if replion then
			local success, bagData = pcall(function()
				return replion:GetExpect("Bag")
			end)
			if success and bagData then
				local count = 0
				for _, item in pairs(bagData) do
					if item and item.Count then
						count = count + item.Count
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d", math.ceil(detectorTimer)))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Bag: %d", getBagCount()))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		lastResetTime = tick()
		currentStatus = "Resetting..."

		pcall(function()
			player.Character:BreakJoints()
		end)

		task.wait(5)

		-- Teleport back to original position
		if originalPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(originalPosition)
				task.wait(0.5)
			end
		end

		-- Re-equip rod
		pcall(function() REEquipToolFromHotbar:FireServer(1) end)
		task.wait(2)

		currentStatus = "Ready"
		updateDisplays()
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		if not isRodEquipped() then
			Notifier.new({
				Title = "Error",
				Content = "No fishing rod equipped!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		smartDetectorEnabled = true
		detectorTimer = waitTime

		-- Save original position
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
			lastCastPosition = originalPosition
		end

		currentStatus = "Active"
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Started monitoring fishing activity",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})

		-- Timer countdown loop
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(1)
				detectorTimer = detectorTimer - 1
				updateDisplays()

				if detectorTimer <= 0 then
					if (tick() - lastResetTime) >= RESET_COOLDOWN then
						Notifier.new({
							Title = "Smart Detector",
							Content = "Timer expired - resetting character",
							Duration = 3,
							Icon = "rbxassetid://95448792622941"
						})
						resetCharacter()
						detectorTimer = waitTime
					else
						detectorTimer = waitTime
					end
				end
			end
		end)

		-- Status monitoring loop
		task.spawn(function()
			local lastMinigameTime = nil

			while smartDetectorEnabled do
				pcall(function()
					if not isRodEquipped() then
						currentStatus = "No Rod"
						task.wait(1)
						return
					end

					local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

					if currentMinigameActive then
						currentStatus = "Minigame"

						if not lastMinigameTime then
							lastMinigameTime = tick()
						end

						local elapsed = tick() - lastMinigameTime

						if elapsed >= 1.1 then
							-- Complete the minigame
							pcall(function() finishRemote:FireServer() end)
							lastMinigameTime = nil

							-- Reset timer since fish was completed
							detectorTimer = waitTime
							currentStatus = "Fish Caught"
							updateDisplays()

							Notifier.new({
								Title = "Smart Detector",
								Content = "Fish completed - timer reset",
								Duration = 2,
								Icon = "rbxassetid://95448792622941"
							})

							task.wait(1)
							currentStatus = "Active"
						end
					else
						if lastMinigameTime then
							lastMinigameTime = nil
						end

						-- Check if casting
						if FishingController._getPower and FishingController:_getPower() > 0 then
							currentStatus = "Casting"
						else
							currentStatus = "Idle"
						end
					end
				end)

				task.wait(0.1)
			end
		end)

		-- Position tracking loop
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(2)
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local hrp = player.Character.HumanoidRootPart

					if lastCastPosition then
						local distanceFromLastCast = (hrp.Position - lastCastPosition).Magnitude

						if distanceFromLastCast >= 10 then
							originalPosition = hrp.Position
							lastCastPosition = originalPosition
						end
					elseif originalPosition then
						local distance = (hrp.Position - originalPosition).Magnitude
						if distance >= 10 then
							originalPosition = hrp.Position
							lastCastPosition = hrp.Position
						end
					else
						originalPosition = hrp.Position
						lastCastPosition = hrp.Position
					end
				end
			end
		end)
	end

	local function stopSmartDetector()
		smartDetectorEnabled = false
		currentStatus = "Inactive"
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Stopped monitoring",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: " .. detectorTimer
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Bag: " .. getBagCount()
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			if not smartDetectorEnabled then
				detectorTimer = waitTime
				updateDisplays()
			end

			Notifier.new({
				Title = "Wait Time",
				Content = "Set to " .. value .. " seconds",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});
end
