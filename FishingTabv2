-- Fishing Tab for FishClarity
-- Smart Detector feature for stuck detection and auto-reset

return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")
	local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay
	local initialFishCount = 0 -- Fish count when detector started
	local fishCaughtSinceStart = 0 -- Fish caught since detector started

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get total fish count from inventory
	local function getTotalFishCount()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)
			if success and items then
				local count = 0
				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" then
						count = count + (item.Count or 1)
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d/%d", detectorTimer, waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Fish Caught: %d", fishCaughtSinceStart))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		lastResetTime = tick()
		currentStatus = "Resetting..."

		-- Update original position to current location before resetting
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
		end

		pcall(function()
			player.Character:BreakJoints()
		end)

		task.wait(5)

		-- Teleport back to original position
		if originalPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(originalPosition)
				task.wait(0.5)
			end
		end

		-- Re-equip rod
		pcall(function() REEquipToolFromHotbar:FireServer(1) end)
		task.wait(2)

		currentStatus = "Ready"
		updateDisplays()
	end

	-- Stop Smart Detector and reset all variables
	local function stopSmartDetector()
		smartDetectorEnabled = false
		detectorTimer = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = "Inactive"
		initialFishCount = 0
		fishCaughtSinceStart = 0
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Stopped monitoring",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		if not isRodEquipped() then
			Notifier.new({
				Title = "Error",
				Content = "No fishing rod equipped!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		-- Reset all variables
		smartDetectorEnabled = true
		detectorTimer = 0 -- Start from 0
		initialFishCount = getTotalFishCount()
		fishCaughtSinceStart = 0

		-- Save original position
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
			lastCastPosition = originalPosition
		end

		currentStatus = "Active"
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Started monitoring fishing activity",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})

		-- Timer countdown loop
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(1)
				detectorTimer = detectorTimer + 1
				updateDisplays()

				if detectorTimer >= waitTime then
					if (tick() - lastResetTime) >= RESET_COOLDOWN then
						Notifier.new({
							Title = "Smart Detector",
							Content = "Timer expired - resetting character",
							Duration = 3,
							Icon = "rbxassetid://95448792622941"
						})
						resetCharacter()
						detectorTimer = 0
					else
						detectorTimer = 0
					end
				end
			end
		end)

		-- Status monitoring loop
		task.spawn(function()
			local lastMinigameTime = nil
			local isCasting = false
			local lastPowerCheck = 0

			while smartDetectorEnabled do
				pcall(function()
					if not isRodEquipped() then
						currentStatus = "No Rod"
						task.wait(1)
						return
					end

					local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

					if currentMinigameActive then
						currentStatus = "Minigame"
						isCasting = false

						if not lastMinigameTime then
							lastMinigameTime = tick()
						end

						local elapsed = tick() - lastMinigameTime

						if elapsed >= 1.1 then
							-- Complete the minigame
							pcall(function() finishRemote:FireServer() end)
							lastMinigameTime = nil

							-- Check if fish was caught
							task.wait(0.5)
							local newFishCount = getTotalFishCount()
							if newFishCount > initialFishCount then
								-- Fish was caught, reset timer
								detectorTimer = 0
								fishCaughtSinceStart = newFishCount - initialFishCount
								currentStatus = "Fish Caught"
								updateDisplays()

								Notifier.new({
									Title = "Smart Detector",
									Content = "Fish completed - timer reset",
									Duration = 2,
									Icon = "rbxassetid://95448792622941"
								})

								task.wait(1)
								currentStatus = "Active"
							end
						end
					else
						if lastMinigameTime then
							lastMinigameTime = nil
						end

						-- Check if casting (only when power is actively building)
						local now = tick()
						if now - lastPowerCheck >= 0.1 then
							lastPowerCheck = now

							if FishingController._getPower then
								local currentPower = FishingController:_getPower()
								local isPowerBuilding = false

								-- Check if power is increasing (actually casting)
								if currentPower > 0.01 then
									task.wait(0.05)
									local nextPower = FishingController:_getPower()
									isPowerBuilding = nextPower > currentPower
								end

								if isPowerBuilding then
									if not isCasting then
										isCasting = true
										currentStatus = "Casting"
									end
								else
									if isCasting then
										isCasting = false
										currentStatus = "Idle"
									end
								end
							else
								currentStatus = "Idle"
								isCasting = false
							end
						end
					end
				end)

				task.wait(0.05) -- More frequent checks for better status detection
			end
		end)

		-- Position tracking loop - constantly update original position
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(1) -- Check every second
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local hrp = player.Character.HumanoidRootPart
					local currentPos = hrp.Position

					-- Always update original position to current location
					-- This ensures we teleport back to where we are when reset triggers
					originalPosition = currentPos
					lastCastPosition = currentPos
				end
			end
		end)
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: 0/" .. waitTime
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Fish Caught: " .. fishCaughtSinceStart
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			-- Don't update timer here, just change the selected time
			updateDisplays()

			Notifier.new({
				Title = "Wait Time",
				Content = "Set to " .. value .. " seconds",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});
end
