-- Fishing Tab for FishClarity
-- Smart Detector feature for stuck detection and auto-reset

return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")
	local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local originalCFrame = nil  -- Store full CFrame for rotation preservation
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay
	local initialFishCount = 0 -- Fish count when detector started
	local fishCaughtSinceStart = 0 -- Fish caught since detector started
	
	-- Connections for Smart Detector loops
	local timerConnection = nil
	local statusConnection = nil

	-- Auto Fish variables
	local legitAutoFishEnabled = false
	local autoEquipRodEnabled = false
	local autoClickMinigameEnabled = false
	local legitDelay = 1.1
	local shakeDelay = 0.1
	local manipulationDelay = 0.12
	local autoFishConnection = nil
	local equipRodConnection = nil
	local standaloneMinigameLoop = nil

	-- ============================================
	-- LEGIT AUTO FISH VARIABLES
	-- ============================================
	local legitAutoFishEnabled = false
	local legitFishingLoop = nil
	local legitMinigameActive = false
	local legitMinigameConnection = nil
	local autoClickMinigameEnabled = false
	local legitDelay = 1.1
	local shakeDelay = 0.1
	local manipulationDelay = 0.12

	-- ============================================
	-- AUTO EQUIP ROD VARIABLES
	-- ============================================
	local autoEquipRodEnabled = false
	local autoEquipConnection = nil

	-- ============================================
	-- EVENT FISHING VARIABLES
	-- ============================================
	local eventTeleportEnabled = false
	local selectedEvents = {}
	local prioritizedEvent = "Ghost Shark Hunt"
	local eventTeleportConnection = nil

	-- ============================================
	-- FAVORITE SYSTEM VARIABLES
	-- ============================================
	local autoFavoriteEnabled = false
	local autoUnfavoriteEnabled = false
	local selectedFishNames = {}
	local selectedRarity = {}
	local selectedVariant = {}
	local favoriteConnection = nil

	-- ============================================
	-- AUTO SELL VARIABLES
	-- ============================================
	local autoSellEnabled = false
	local sellThreshold = 0
	local sellConnection = nil

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get total fish count from inventory
	local function getTotalFishCount()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)
			if success and items then
				local count = 0
				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" then
						count = count + (item.Count or 1)
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d/%d", detectorTimer, waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Fish Caught: %d", fishCaughtSinceStart))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- ============================================
	-- LEGIT AUTO FISH FUNCTIONS
	-- ============================================

	-- Stop legit auto fish
	local function StopLegitAutoFish()
		legitAutoFishEnabled = false
		if legitFishingLoop then
			task.cancel(legitFishingLoop)
			legitFishingLoop = nil
		end
	end

	-- Start legit auto fish
	local function StartLegitAutoFish()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		if not isRodEquipped() then
			Notifier.new({
				Title = "Error",
				Content = "No fishing rod equipped!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		if legitAutoFishEnabled then return end
		legitAutoFishEnabled = true

		-- Minigame monitoring
		task.spawn(function()
			local minigameStartTime = nil

			while legitAutoFishEnabled do
				pcall(function()
					if not isRodEquipped() then
						task.wait(1)
						return
					end

					local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

					if currentMinigameActive then
						if not minigameStartTime then
							minigameStartTime = tick()
						end

						local elapsed = tick() - minigameStartTime

						if legitDelay > 0 and elapsed >= legitDelay then  -- Only fire remote if legitDelay > 0
							pcall(function() finishRemote:FireServer() end)
							minigameStartTime = nil
							task.wait(0.1)
						else
							if elapsed >= manipulationDelay then
								pcall(function() FishingController:FishingMinigameClick() end)
							end
							task.wait(0.1)
						end
					else
						minigameStartTime = nil
						task.wait(0.02)
					end
				end)
			end
		end)

		-- Main casting loop
		legitFishingLoop = task.spawn(function()
			while legitAutoFishEnabled do
				pcall(function()
					if not isRodEquipped() then
						task.wait(1)
						return
					end

					if not FishingController:GetCurrentGUID() then
						local camera = workspace.CurrentCamera
						local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

						FishingController:RequestChargeFishingRod(screenCenter, false)
						task.wait(0.1)

						local initialPower = FishingController:_getPower()
						task.wait(0.1)
						local checkPower = FishingController:_getPower()

						-- Less strict check for power charging - allow small increases
						if checkPower <= initialPower + 0.05 then
							task.wait(0.5)
							return
						end

						-- Smart power timing with cooldown awareness and ping compensation
						local ping = game:GetService("Stats"):GetStat("Data Ping")
						local pingCompensation = math.min(ping / 1000 * 2, 0.1) -- Max 100ms compensation
						local optimalCastTime = workspace:GetServerTimeNow() + 0.14 + pingCompensation -- Account for cooldown + ping
						
						local attempts = 0
						local lastPower = 0
						local powerIncreasing = true
						
						repeat
							task.wait(0.005) -- More frequent checks for precision
							local currentPower = FishingController:_getPower()
							
							if currentPower < lastPower then
								powerIncreasing = false -- Peak detected, power is dropping
							end
							
							-- Cast when: power is high enough OR we've reached optimal timing
							local timeUntilCastReady = optimalCastTime - workspace:GetServerTimeNow()
							local shouldCastNow = currentPower >= 0.95 or 
												(timeUntilCastReady <= 0 and currentPower >= 0.8) or
												(not powerIncreasing and currentPower >= 0.85) -- Cast at peak
							
							if shouldCastNow then
								break
							end
							
							lastPower = currentPower
							attempts += 1
						until attempts >= 100 or not legitAutoFishEnabled

						if legitAutoFishEnabled and FishingController:_getPower() >= 0.5 then
							pcall(function()
								local power = FishingController:_getPower()

								-- Sync throw animation with cast timing to prevent desync
								if AnimationController then
									pcall(function()
										AnimationController:DestroyActiveAnimationTracks()
										AnimationController:PlayAnimation("RodThrow")
									end)
								end

								-- Execute cast immediately after animation starts
								FishingController:UpdateChargeState(nil)
								local success, fishData = FishingController:SendFishingRequestToServer(screenCenter, power)
								if success and fishData then
									task.wait(0.3)
									FishingController:FishingRodStarted(fishData)
								end
							end)
						end
						-- Dynamic cooldown detection with ping compensation
						local ping = game:GetService("Stats"):GetStat("Data Ping")
						local pingCompensation = math.min(ping / 1000 * 2, 0.1) -- Max 100ms compensation
						local cooldownEndTime = workspace:GetServerTimeNow() + 0.14 + pingCompensation -- 0.14s cooldown + ping buffer
						while workspace:GetServerTimeNow() < cooldownEndTime and legitAutoFishEnabled do
							task.wait(0.01)
						end
					else
						task.wait(0.1)
					end
				end)
			end
		end)
	end

	-- ============================================
	-- AUTO EQUIP ROD FUNCTIONS
	-- ============================================

	-- Start auto equip rod
	local function startAutoEquipRod()
		if autoEquipConnection then
			autoEquipConnection:Disconnect()
		end

		autoEquipConnection = replion:OnChange({"EquippedType"}, function(newType)
			if autoEquipRodEnabled and newType ~= "Fishing Rods" then
				pcall(function() REEquipToolFromHotbar:FireServer(1) end)
			end
		end)
	end

	-- Stop auto equip rod
	local function stopAutoEquipRod()
		if autoEquipConnection then
			autoEquipConnection:Disconnect()
			autoEquipConnection = nil
		end
	end

	-- ============================================
	-- STANDALONE AUTO CLICK MINIGAME FUNCTIONS
	-- ============================================

	-- Start standalone auto click minigame
	local function StartStandaloneAutoClickMinigame()
		if standaloneMinigameLoop then return end

		standaloneMinigameLoop = task.spawn(function()
			local minigameStartTime = nil
			local lastMinigameState = false

			while autoClickMinigameEnabled do
				pcall(function()
					if not FishingController then
						task.wait(0.1)
						return
					end

					local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

					if currentMinigameActive then
						if not minigameStartTime then
							minigameStartTime = tick()
						end

						local minigameElapsedTime = tick() - minigameStartTime

						if legitDelay and legitDelay > 0 and minigameElapsedTime >= legitDelay then
							pcall(function()
								finishRemote:FireServer()
							end)

							minigameStartTime = nil
							task.wait(0.1)
						else
							if minigameElapsedTime >= shakeDelay then
								FishingController:FishingMinigameClick()
								task.wait(0.01)
							else
								task.wait(0.01)
							end
						end
					else
						minigameStartTime = nil
						task.wait(0.05)
					end

					lastMinigameState = currentMinigameActive
				end)
			end
			standaloneMinigameLoop = nil
		end)
	end

	-- Stop standalone auto click minigame
	local function StopStandaloneAutoClickMinigame()
		autoClickMinigameEnabled = false
		if standaloneMinigameLoop then
			pcall(function()
				task.cancel(standaloneMinigameLoop)
			end)
			standaloneMinigameLoop = nil
		end
	end

	-- ============================================
	-- RESET CHARACTER FUNCTIONS
	-- ============================================

	-- ============================================
	-- SMART DETECTOR FUNCTIONS
	-- ============================================

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		lastResetTime = tick()
		currentStatus = "Resetting..."
		updateDisplays()

		-- Save current position RIGHT BEFORE resetting
		local savedPosition = nil
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			savedPosition = player.Character.HumanoidRootPart.Position
		end

		-- Reset character
		pcall(function()
			player.Character:BreakJoints()
		end)

		-- Wait for player to respawn (detect when character is added back)
		local respawned = false
		local connection
		connection = player.CharacterAdded:Connect(function(newChar)
			respawned = true
			connection:Disconnect()
		end)

		-- Wait for respawn (max 10 seconds timeout)
		local waitStart = tick()
		while not respawned and (tick() - waitStart) < 10 do
			task.wait(0.1)
		end

		if connection then
			connection:Disconnect()
		end

		-- Wait 2 seconds after respawn finishes
		task.wait(2)

		-- Teleport back to saved position
		if savedPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(savedPosition)
				task.wait(0.5)
			end
		end

		-- Re-equip rod
		pcall(function() REEquipToolFromHotbar:FireServer(1) end)
		task.wait(2)

		currentStatus = "Ready"
		updateDisplays()
	end

	-- Stop Smart Detector and reset all variables
	local function stopSmartDetector()
		smartDetectorEnabled = false
		
		-- Disconnect existing connections
		if timerConnection then
			timerConnection:Disconnect()
			timerConnection = nil
		end
		if statusConnection then
			statusConnection:Disconnect()
			statusConnection = nil
		end
		
		detectorTimer = 0
		originalPosition = nil
		originalCFrame = nil
		lastCastPosition = nil
		currentStatus = "Inactive"
		initialFishCount = 0
		fishCaughtSinceStart = 0
		
		-- Force update displays to reset values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: Inactive")
		end
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		-- FULLY RESET all variables when starting
		smartDetectorEnabled = true
		detectorTimer = 0
		initialFishCount = getTotalFishCount()
		fishCaughtSinceStart = 0
		lastResetTime = 0
		originalPosition = nil
		originalCFrame = nil
		lastCastPosition = nil
		currentStatus = isRodEquipped() and "Active" or "No Rod"

		-- Save original position and rotation
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			local hrp = player.Character.HumanoidRootPart
			originalPosition = hrp.Position  -- Keep as Vector3 for distance calculations
			originalCFrame = hrp.CFrame     -- Store full CFrame for rotation preservation
			lastCastPosition = originalPosition
		end

		-- Force update all displays with fresh values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end

		-- Timer countdown connection (runs every second)
		local lastTimerUpdate = tick()
		timerConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastTimerUpdate >= 1 then
				lastTimerUpdate = currentTime
				
				-- Only increment timer if rod is equipped
				if isRodEquipped() then
					detectorTimer = detectorTimer + 1
					updateDisplays()

					if detectorTimer >= waitTime then
						if (tick() - lastResetTime) >= RESET_COOLDOWN then
							Notifier.new({
								Title = "Smart Detector",
								Content = "Timer expired - resetting character",
								Duration = 3,
								Icon = "rbxassetid://95448792622941"
							})
							resetCharacter()
							detectorTimer = 0
						else
							detectorTimer = 0
						end
					end
				else
					-- Reset timer if no rod equipped
					detectorTimer = 0
					updateDisplays()
				end
			end
		end)

		-- Status monitoring connection (runs every 0.1 seconds)
		local lastMinigameTime = nil
		local lastStatusUpdate = tick()
		statusConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastStatusUpdate < 0.1 then return end
			lastStatusUpdate = currentTime
			
			pcall(function()
				if not isRodEquipped() then
					currentStatus = "No Rod"
					updateDisplays()
					return
				end

				local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

				if currentMinigameActive then
					currentStatus = "Minigame"
					updateDisplays()

					if not lastMinigameTime then
						lastMinigameTime = tick()
					end

					local elapsed = tick() - lastMinigameTime

					if elapsed >= 1.1 then
						-- Complete the minigame
						pcall(function() finishRemote:FireServer() end)
						lastMinigameTime = nil

						-- Check if fish was caught and handle stuck recovery
						task.spawn(function()
							task.wait(0.5)
							local currentTime = tick()
							
							-- Check if minigame is still active (stuck)
							if FishingController:GetCurrentGUID() ~= nil and smartDetectorEnabled and (currentTime - lastResetTime) >= RESET_COOLDOWN then
								print("Minigame stuck detected! Resetting character...")
								lastResetTime = currentTime
								local wasEnabled = smartDetectorEnabled
								smartDetectorEnabled = false

								pcall(function()
									if player.Character then player.Character:BreakJoints() end
								end)

								print("Character reset initiated")
								task.wait(5)

								if wasEnabled then
									if originalCFrame and player.Character then
										local hrp = player.Character:FindFirstChild("HumanoidRootPart")
										if hrp then
											print("Teleporting to original position with rotation:", originalCFrame.Position, originalCFrame.LookVector)
											hrp.CFrame = originalCFrame
											task.wait(0.5)
										end
									end

									print("Re-equipping rod...")
									pcall(function() REEquipToolFromHotbar:FireServer(1) end)
									task.wait(2)

									if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
										local hrp = player.Character.HumanoidRootPart
										originalPosition = hrp.Position
										originalCFrame = hrp.CFrame
										lastCastPosition = originalPosition
										print("Position and rotation updated after reset")
									end

									print("Stuck recovery completed - restarting smart detector")
									task.wait(1)
									startSmartDetector()
								end
							else
								-- Check if fish was caught normally
								local newFishCount = getTotalFishCount()
								if newFishCount > initialFishCount then
									-- Fish was caught, reset timer
									detectorTimer = 0
									fishCaughtSinceStart = newFishCount - initialFishCount
									currentStatus = "Fish Caught"
									updateDisplays()

									task.wait(1)
									currentStatus = "Active"
									updateDisplays()
								end
							end
						end)
					end
				else
					if lastMinigameTime then
						lastMinigameTime = nil
					end

					-- Simple status detection: if rod equipped and not in minigame, check if casting
					if FishingController._getPower then
						local currentPower = FishingController:_getPower()

						-- If power is above 0, player is actively casting
						if currentPower > 0 then
							currentStatus = "Casting"
						else
							-- Rod equipped, not in minigame, power is 0 = Idle
							currentStatus = "Idle"
						end
					else
						-- Fallback: if we can't check power, assume Idle when rod is equipped
						currentStatus = "Idle"
					end

					updateDisplays()
				end
			end)
		end)
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: 0/" .. waitTime
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Fish Caught: " .. fishCaughtSinceStart
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			-- Don't update timer here, just change the selected time
			updateDisplays()
		end,
	});

	-- ============================================
	-- AUTO FISH SECTION
	-- ============================================

	local AutoFishSection = FishingTab:DrawSection({
		Name = "Auto Fish",
		Icon = "rbxassetid://95448792622941"
	});

	-- Legit Auto Fish toggle
	AutoFishSection:AddToggle({
		Name = "Legit Auto Fish",
		Default = false,
		Callback = function(Value)
			if Value then
				StartLegitAutoFish()
				Notifier.new({
					Title = "Legit Auto Fish",
					Content = "Legit auto fish enabled",
					Duration = 3,
					Icon = "rbxassetid://95448792622941"
				});
			else
				StopLegitAutoFish()
				Notifier.new({
					Title = "Legit Auto Fish",
					Content = "Legit auto fish disabled",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				});
			end
		end,
	});

	-- Auto Equip Rod toggle
	AutoFishSection:AddToggle({
		Name = "Auto Equip Rod",
		Default = false,
		Callback = function(Value)
			autoEquipRodEnabled = Value

			if Value then
				startAutoEquipRod()
				Notifier.new({
					Title = "Auto Equip Rod",
					Content = "Auto Equip Rod enabled",
					Duration = 3,
					Icon = "rbxassetid://95448792622941"
				});
			else
				stopAutoEquipRod()
				Notifier.new({
					Title = "Auto Equip Rod",
					Content = "Auto Equip Rod disabled",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				});
			end
		end,
	});

	-- Auto Click Minigame toggle
	AutoFishSection:AddToggle({
		Name = "Auto Click Minigame",
		Default = false,
		Callback = function(Value)
			autoClickMinigameEnabled = Value

			if Value then
				StartStandaloneAutoClickMinigame()
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Auto Click Minigame enabled",
					Duration = 3,
					Icon = "rbxassetid://95448792622941"
				});
			else
				StopStandaloneAutoClickMinigame()
				Notifier.new({
					Title = "Auto Click Minigame",
					Content = "Auto Click Minigame disabled",
					Duration = 2,
					Icon = "rbxassetid://95448792622941"
				});
			end
		end,
	});

	-- Legit Delay textbox
	AutoFishSection:AddTextBox({
		Name = "Legit Delay",
		Default = "1.1",
		Placeholder = "0-10 seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0 and value <= 10 then
				legitDelay = value
			end
		end,
	});

	-- MiniGame Delay textbox
	AutoFishSection:AddTextBox({
		Name = "MiniGame Delay",
		Default = "0.1",
		Placeholder = "0+ seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0 then
				shakeDelay = value
			end
		end,
	});

	-- Manipulation Delay textbox
	AutoFishSection:AddTextBox({
		Name = "Manipulation Delay",
		Default = "0.12",
		Placeholder = "0.1-1 seconds",
		Callback = function(Text)
			local value = tonumber(Text)
			if value and value >= 0.1 and value <= 1 then
				manipulationDelay = value
			end
		end,
	});
end
