-- Fishing Tab for FishClarity
-- Smart Detector feature for stuck detection and auto-reset
--v6
return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")
	local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay
	local initialFishCount = 0 -- Fish count when detector started
	local fishCaughtSinceStart = 0 -- Fish caught since detector started
	
	-- Connections for Smart Detector loops
	local timerConnection = nil
	local statusConnection = nil

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get total fish count from inventory
	local function getTotalFishCount()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)
			if success and items then
				local count = 0
				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" then
						count = count + (item.Count or 1)
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d/%d", detectorTimer, waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Fish Caught: %d", fishCaughtSinceStart))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		lastResetTime = tick()
		currentStatus = "Resetting..."
		updateDisplays()

		-- Save current position RIGHT BEFORE resetting
		local savedPosition = nil
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			savedPosition = player.Character.HumanoidRootPart.Position
		end

		-- Reset character
		pcall(function()
			player.Character:BreakJoints()
		end)

		-- Wait for player to respawn (detect when character is added back)
		local respawned = false
		local connection
		connection = player.CharacterAdded:Connect(function(newChar)
			respawned = true
			connection:Disconnect()
		end)

		-- Wait for respawn (max 10 seconds timeout)
		local waitStart = tick()
		while not respawned and (tick() - waitStart) < 10 do
			task.wait(0.1)
		end

		if connection then
			connection:Disconnect()
		end

		-- Wait 2 seconds after respawn finishes
		task.wait(2)

		-- Teleport back to saved position
		if savedPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(savedPosition)
				task.wait(0.5)
			end
		end

		-- Re-equip rod
		pcall(function() REEquipToolFromHotbar:FireServer(1) end)
		task.wait(2)

		currentStatus = "Ready"
		updateDisplays()
	end

	-- Stop Smart Detector and reset all variables
	local function stopSmartDetector()
		smartDetectorEnabled = false
		
		-- Disconnect existing connections
		if timerConnection then
			timerConnection:Disconnect()
			timerConnection = nil
		end
		if statusConnection then
			statusConnection:Disconnect()
			statusConnection = nil
		end
		
		detectorTimer = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = "Inactive"
		initialFishCount = 0
		fishCaughtSinceStart = 0
		
		-- Force update displays to reset values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: Inactive")
		end

		Notifier.new({
			Title = "Smart Detector",
			Content = "Stopped monitoring",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://95448792622941"
			})
			return
		end

		-- FULLY RESET all variables when starting
		smartDetectorEnabled = true
		detectorTimer = 0
		initialFishCount = getTotalFishCount()
		fishCaughtSinceStart = 0
		lastResetTime = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = isRodEquipped() and "Active" or "No Rod"

		-- Save original position
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
			lastCastPosition = originalPosition
		end

		-- Force update all displays with fresh values
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: 0/%d", waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent("Fish Caught: 0")
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end

		Notifier.new({
			Title = "Smart Detector",
			Content = "Started monitoring fishing activity",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})

		-- Timer countdown connection (runs every second)
		local lastTimerUpdate = tick()
		timerConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastTimerUpdate >= 1 then
				lastTimerUpdate = currentTime
				
				-- Only increment timer if rod is equipped
				if isRodEquipped() then
					detectorTimer = detectorTimer + 1
					updateDisplays()

					if detectorTimer >= waitTime then
						if (tick() - lastResetTime) >= RESET_COOLDOWN then
							Notifier.new({
								Title = "Smart Detector",
								Content = "Timer expired - resetting character",
								Duration = 3,
								Icon = "rbxassetid://95448792622941"
							})
							resetCharacter()
							detectorTimer = 0
						else
							detectorTimer = 0
						end
					end
				else
					-- Reset timer if no rod equipped
					detectorTimer = 0
					updateDisplays()
				end
			end
		end)

		-- Status monitoring connection (runs every 0.1 seconds)
		local lastMinigameTime = nil
		local lastStatusUpdate = tick()
		statusConnection = RunService.Heartbeat:Connect(function()
			if not smartDetectorEnabled then return end
			
			local currentTime = tick()
			if currentTime - lastStatusUpdate < 0.1 then return end
			lastStatusUpdate = currentTime
			
			pcall(function()
				if not isRodEquipped() then
					currentStatus = "No Rod"
					updateDisplays()
					return
				end

				local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

				if currentMinigameActive then
					currentStatus = "Minigame"
					updateDisplays()

					if not lastMinigameTime then
						lastMinigameTime = tick()
					end

					local elapsed = tick() - lastMinigameTime

					if elapsed >= 1.1 then
						-- Complete the minigame
						pcall(function() finishRemote:FireServer() end)
						lastMinigameTime = nil

						-- Check if fish was caught
						task.wait(0.5)
						local newFishCount = getTotalFishCount()
						if newFishCount > initialFishCount then
							-- Fish was caught, reset timer
							detectorTimer = 0
							fishCaughtSinceStart = newFishCount - initialFishCount
							currentStatus = "Fish Caught"
							updateDisplays()

							Notifier.new({
								Title = "Smart Detector",
								Content = "Fish completed - timer reset",
								Duration = 2,
								Icon = "rbxassetid://95448792622941"
							})

							task.wait(1)
							currentStatus = "Active"
							updateDisplays()
						end
					end
				else
					if lastMinigameTime then
						lastMinigameTime = nil
					end

					-- Simple status detection: if rod equipped and not in minigame, check if casting
					if FishingController._getPower then
						local currentPower = FishingController:_getPower()

						-- If power is above 0, player is actively casting
						if currentPower > 0 then
							currentStatus = "Casting"
						else
							-- Rod equipped, not in minigame, power is 0 = Idle
							currentStatus = "Idle"
						end
					else
						-- Fallback: if we can't check power, assume Idle when rod is equipped
						currentStatus = "Idle"
					end

					updateDisplays()
				end
			end)
		end)
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: 0/" .. waitTime
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Fish Caught: " .. fishCaughtSinceStart
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			-- Don't update timer here, just change the selected time
			updateDisplays()

			Notifier.new({
				Title = "Wait Time",
				Content = "Set to " .. value .. " seconds",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});
end
