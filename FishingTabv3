-- Fishing Tab for FishClarityv4
-- Smart Detector feature for stuck detection and auto-reset

return function(config)
	local FishingTab = config.FishingTab
	local Notifier = config.Notifier

	-- Get required services and controllers
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local VirtualInputManager = game:GetService("VirtualInputManager")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")

	local player = Players.LocalPlayer
	local replion = require(game.ReplicatedStorage.Packages.Replion).Client:WaitReplion("Data")
	local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)

	-- Controllers
	local FishingController
	local AnimationController

	pcall(function()
		FishingController = require(ReplicatedStorage.Controllers.FishingController)
		AnimationController = require(ReplicatedStorage.Controllers.AnimationController)
	end)

	-- Remotes
	local finishRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/FishingCompleted")
	local REEquipToolFromHotbar = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
		:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

	-- Smart Detector variables
	local smartDetectorEnabled = false
	local originalPosition = nil
	local lastCastPosition = nil
	local detectorTimer = 0
	local waitTime = 15 -- default 15 seconds
	local lastResetTime = 0
	local RESET_COOLDOWN = 10
	local currentStatus = "Inactive"
	local timeDisplay, bagDisplay, statusDisplay
	local initialFishCount = 0 -- Fish count when detector started
	local fishCaughtSinceStart = 0 -- Fish caught since detector started

	-- Check if rod is equipped
	local function isRodEquipped()
		if replion then
			local success, equippedType = pcall(function()
				return replion:GetExpect("EquippedType")
			end)
			if success and equippedType == "Fishing Rods" then
				return true
			end
		end
		return false
	end

	-- Get total fish count from inventory
	local function getTotalFishCount()
		if replion then
			local success, items = pcall(function()
				return replion:GetExpect({"Inventory", "Items"})
			end)
			if success and items then
				local count = 0
				for _, item in ipairs(items) do
					local itemData = ItemUtility.GetItemDataFromItemType("Items", item.Id)
					if itemData and itemData.Data and itemData.Data.Type == "Fish" then
						count = count + (item.Count or 1)
					end
				end
				return count
			end
		end
		return 0
	end

	-- Update status displays
	local function updateDisplays()
		if timeDisplay then
			timeDisplay:SetContent(string.format("Timer: %d/%d", detectorTimer, waitTime))
		end
		if bagDisplay then
			bagDisplay:SetContent(string.format("Fish Caught: %d", fishCaughtSinceStart))
		end
		if statusDisplay then
			statusDisplay:SetContent("Status: " .. currentStatus)
		end
	end

	-- Detect what player is doing/facing
	local function detectPlayerActivity()
		if not player.Character then return "No Character" end

		local humanoidRootPart = player.Character:FindFirstChild("HumanoidRootPart")
		local humanoid = player.Character:FindFirstChild("Humanoid")
		if not humanoidRootPart or not humanoid then return "Invalid Character" end

		-- Check if player is moving
		if humanoid.MoveDirection.Magnitude > 0.1 then
			return "Moving"
		end

		-- Check if facing water (basic water detection)
		local lookVector = humanoidRootPart.CFrame.LookVector
		local raycastParams = RaycastParams.new()
		raycastParams.FilterDescendantsInstances = {player.Character}
		raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

		local raycastResult = workspace:Raycast(humanoidRootPart.Position, lookVector * 20, raycastParams)
		if raycastResult then
			local hitPart = raycastResult.Instance
			if hitPart and hitPart:IsA("Terrain") then
				local material = workspace.Terrain:GetMaterial(raycastResult.Position)
				if material == Enum.Material.Water then
					return "Facing Water"
				end
			elseif hitPart and hitPart.Name:lower():find("water") then
				return "Facing Water"
			end
		end

		-- Check if swimming
		if humanoid:GetState() == Enum.HumanoidStateType.Swimming then
			return "Swimming"
		end

		-- Check if jumping
		if humanoid:GetState() == Enum.HumanoidStateType.Jumping then
			return "Jumping"
		end

		-- Check if sitting
		if humanoid.Sit then
			return "Sitting"
		end

		return "Standing Still"
	end

	-- Reset character
	local function resetCharacter()
		if not player.Character then return end

		-- Save current position before reset
		local currentPosition = nil
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			currentPosition = player.Character.HumanoidRootPart.Position
		end

		lastResetTime = tick()
		currentStatus = "Resetting..."

		pcall(function()
			player.Character:BreakJoints()
		end)

		task.wait(5)

		-- Teleport back to saved position (where player was before reset)
		if currentPosition and player.Character then
			local hrp = player.Character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = CFrame.new(currentPosition)
				task.wait(2) -- Wait 2 seconds as requested

				-- Re-equip rod
				pcall(function() REEquipToolFromHotbar:FireServer(1) end)
				task.wait(2)

				currentStatus = "Ready"
				updateDisplays()
			end
		end
	end

	-- Stop Smart Detector and reset all variables
	local function stopSmartDetector()
		smartDetectorEnabled = false
		detectorTimer = 0
		originalPosition = nil
		lastCastPosition = nil
		currentStatus = "Inactive"
		initialFishCount = 0
		fishCaughtSinceStart = 0
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Stopped monitoring",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})
	end

	-- Smart detector main loop
	local function startSmartDetector()
		if not FishingController then
			Notifier.new({
				Title = "Error",
				Content = "FishingController not found!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		if not isRodEquipped() then
			Notifier.new({
				Title = "Error",
				Content = "No fishing rod equipped!",
				Duration = 3,
				Icon = "rbxassetid://124426992222665"
			})
			return
		end

		-- Reset all variables
		smartDetectorEnabled = true
		detectorTimer = 0 -- Start from 0
		initialFishCount = getTotalFishCount()
		fishCaughtSinceStart = 0

		-- Save original position
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			originalPosition = player.Character.HumanoidRootPart.Position
			lastCastPosition = originalPosition
		end

		currentStatus = "Active"
		updateDisplays()

		Notifier.new({
			Title = "Smart Detector",
			Content = "Started monitoring fishing activity",
			Duration = 3,
			Icon = "rbxassetid://95448792622941"
		})

		-- Timer countdown loop
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(1)
				detectorTimer = detectorTimer + 1
				updateDisplays()

				if detectorTimer >= waitTime then
					if (tick() - lastResetTime) >= RESET_COOLDOWN then
						Notifier.new({
							Title = "Smart Detector",
							Content = "Timer expired - resetting character",
							Duration = 3,
							Icon = "rbxassetid://95448792622941"
						})
						resetCharacter()
						detectorTimer = 0
					else
						detectorTimer = 0
					end
				end
			end
		end)

		-- Status monitoring loop
		task.spawn(function()
			local lastMinigameTime = nil

			while smartDetectorEnabled do
				pcall(function()
					if not isRodEquipped() then
						currentStatus = "No Rod"
						updateDisplays()
						task.wait(1)
						return
					end

					local currentMinigameActive = FishingController:GetCurrentGUID() ~= nil

					if currentMinigameActive then
						currentStatus = "Minigame"
						updateDisplays()

						if not lastMinigameTime then
							lastMinigameTime = tick()
						end

						local elapsed = tick() - lastMinigameTime

						if elapsed >= 1.1 then
							-- Complete the minigame
							pcall(function() finishRemote:FireServer() end)
							lastMinigameTime = nil

							-- Check if fish was caught
							task.wait(0.5)
							local newFishCount = getTotalFishCount()
							if newFishCount > initialFishCount then
								-- Fish was caught, reset timer
								detectorTimer = 0
								fishCaughtSinceStart = newFishCount - initialFishCount
								currentStatus = "Fish Caught"
								updateDisplays()

								Notifier.new({
									Title = "Smart Detector",
									Content = "Fish completed - timer reset",
									Duration = 2,
									Icon = "rbxassetid://95448792622941"
								})

								task.wait(1)
								currentStatus = "Active"
								updateDisplays()
							end
						end
					else
						if lastMinigameTime then
							lastMinigameTime = nil
						end

						-- Enhanced status detection with player activity
						local playerActivity = detectPlayerActivity()
						local statusPrefix = ""

						if FishingController._getPower then
							local currentPower = FishingController:_getPower()

							-- If power is above 0, player is actively casting
							if currentPower > 0 then
								statusPrefix = "Casting"
							else
								-- Rod equipped, not in minigame, power is 0 = Idle
								statusPrefix = "Idle"
							end
						else
							-- Fallback: if we can't check power, assume Idle when rod is equipped
							statusPrefix = "Idle"
						end

						-- Combine fishing status with player activity
						currentStatus = statusPrefix .. " (" .. playerActivity .. ")"
						updateDisplays()
					end
				end)

				task.wait(0.1) -- Check every 0.1 seconds for responsive status updates
			end
		end)

		-- Position tracking loop - update last cast position for reference
		task.spawn(function()
			while smartDetectorEnabled do
				task.wait(1) -- Check every second
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local hrp = player.Character.HumanoidRootPart
					local currentPos = hrp.Position

					-- Update last cast position for reference (originalPosition is saved before reset)
					lastCastPosition = currentPos
				end
			end
		end)
	end

	-- Create Fishing Features section
	local FishingFeaturesSection = FishingTab:DrawSection({
		Name = "Fishing Features",
	});

	-- Status displays
	timeDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Time",
		Content = "Timer: 0/" .. waitTime
	});

	bagDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Bag",
		Content = "Fish Caught: " .. fishCaughtSinceStart
	});

	statusDisplay = FishingFeaturesSection:AddParagraph({
		Title = "Status",
		Content = "Status: " .. currentStatus
	});

	-- Smart Detector toggle
	FishingFeaturesSection:AddToggle({
		Name = "Smart Detector",
		Default = false,
		Callback = function(enabled)
			if enabled then
				startSmartDetector()
			else
				stopSmartDetector()
			end
		end,
	});

	-- Wait Time slider
	FishingFeaturesSection:AddSlider({
		Name = "Wait Time",
		Min = 10,
		Max = 25,
		Default = 15,
		Round = 0,
		Callback = function(value)
			waitTime = value
			-- Don't update timer here, just change the selected time
			updateDisplays()

			Notifier.new({
				Title = "Wait Time",
				Content = "Set to " .. value .. " seconds",
				Duration = 2,
				Icon = "rbxassetid://95448792622941"
			})
		end,
	});
end
